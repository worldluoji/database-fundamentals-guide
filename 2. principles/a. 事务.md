# MySQL事务

数据库中的事务是指对数据库执行的一组操作，这些操作在同一个事务中要么全部成功执行，要么全部失败回滚，确保不会出现部分成功的情况。

---

## 开启事务的两种主要方式

1. **手动控制事务**：
   - 使用 `BEGIN` 或 `START TRANSACTION` 开启一个事务。
   - 使用 `ROLLBACK` 回滚事务，撤销所有未提交的操作。
   - 使用 `COMMIT` 提交事务，确认所有操作生效。

2. **自动提交模式**：
   - 默认情况下，MySQL 的 `AUTOCOMMIT` 是开启的（值为 `1`），即每条 SQL 语句都会自动提交。
   - 可以通过 `SET AUTOCOMMIT=0` 关闭自动提交，此时需要手动使用 `COMMIT` 或 `ROLLBACK` 来结束事务。

---

## MySQL事务的四大特性（ACID）

1. **原子性（Atomicity）**：
   - 事务中的所有操作要么全部成功，要么全部失败，不会出现部分成功的情况。

2. **一致性（Consistency）**：
   - 事务开始和结束后，数据库的完整性约束不会被破坏，数据始终处于一致状态。

3. **隔离性（Isolation）**：
   - 多个事务并发执行时，彼此之间相互隔离，不会互相干扰。

4. **持久性（Durability）**：
   - 事务提交后，对数据的修改是永久性的，即使系统崩溃也不会丢失。

---

## MySQL事务的隔离级别

### 查看当前隔离级别
```sql
SELECT @@transaction_isolation;  -- MySQL 默认是可重复读（REPEATABLE READ）
```
对于 MariaDB：
```sql
SELECT @@session.tx_isolation;
```

### 修改隔离级别
```sql
SET SESSION TRANSACTION ISOLATION LEVEL <level>;
```
`<level>` 的取值包括：

1. **读未提交（READ UNCOMMITTED）**：
   - 可以读取到其他事务未提交的数据。
   - 问题：可能导致脏读、不可重复读和幻读。

2. **读已提交（READ COMMITTED）**：
   - 只能读取到其他事务已提交的数据。
   - 解决：脏读问题。
   - 问题：仍可能出现不可重复读和幻读。

3. **可重复读（REPEATABLE READ，MySQL 默认级别）**：
   - 确保在同一个事务中多次读取同一数据时，结果一致。
   - 解决：脏读和不可重复读问题。
   - 问题：仍可能出现幻读。

   **示例**：
   假设你在管理一个银行账户表，包含账户余额和账单明细。月底校对时，你希望即使有新交易发生，也不影响校对结果。使用“可重复读”隔离级别可以确保事务启动时的视图是静态的，不受其他事务更新的影响。

4. **串行化（SERIALIZABLE）**：
   - 最高隔离级别，所有操作串行执行。
   - 解决：脏读、不可重复读和幻读问题。
   - 问题：性能较差，因为会对读取的数据加锁，导致并发性能下降。

---

## 事务并发问题

1. **脏读（Dirty Read）**：
   - 事务 A 读取了事务 B 未提交的数据，而事务 B 随后回滚，导致事务 A 读取到的数据是无效的。
   - 发生场景：`READ UNCOMMITTED` 隔离级别。

2. **不可重复读（Non-Repeatable Read）**：
   - 事务 A 在多次读取同一数据时，由于事务 B 的修改，导致前后读取的结果不一致。
   - 发生场景：`READ COMMITTED` 隔离级别。

3. **幻读（Phantom Read）**：
   - 事务 A 在多次查询同一张表时，由于事务 B 的插入操作，导致前后查询结果的行数不一致。
   - 发生场景：`REPEATABLE READ` 隔离级别下的“当前读”（如 `SELECT ... FOR UPDATE`）。

   **注意**：
   - 在 `REPEATABLE READ` 隔离级别下，普通查询（快照读）不会看到其他事务新增的记录，只有在“当前读”时才会出现幻读。

---

## 总结

- MySQL 事务通过 ACID 特性确保数据的一致性和可靠性。
- 隔离级别决定了事务之间的可见性和并发性能，应根据业务需求选择合适的隔离级别。
- 脏读、不可重复读和幻读是事务并发中的常见问题，不同隔离级别可以解决不同层次的问题。
- 默认的 `REPEATABLE READ` 隔离级别在大多数场景下能够平衡性能和数据一致性。