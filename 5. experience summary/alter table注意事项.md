# alter table注意事项
为 MySQL 数据表添加字段（`ALTER TABLE xxx ADD COLUMN yyy`）确实存在一定的风险，尤其是在生产环境中操作时。以下是可能的风险和注意事项：

---

## 1. **锁表风险**
- **表级锁**：
  - 在 MySQL 5.6 及更早版本中，`ALTER TABLE` 操作会锁定整个表，导致表在操作期间不可读写。
  - 如果表数据量较大，锁表时间可能较长，影响业务正常运行。
- **行级锁（Online DDL）**：
  - 在 MySQL 5.6 及以上版本中，支持 Online DDL（在线数据定义语言），允许在添加字段时不锁定整个表。
  - 但即使使用 Online DDL，某些操作仍可能触发短暂的锁表（如元数据锁）。

---

## 2. **性能影响**
- **大表操作耗时**：
  - 如果表数据量非常大（如数百万行），添加字段可能需要较长时间，导致数据库性能下降。
- **磁盘和 CPU 压力**：
  - `ALTER TABLE` 操作会消耗大量磁盘 I/O 和 CPU 资源，尤其是在需要重建表的情况下。

---

## 3. **数据一致性风险**
- **事务中断**：
  - 如果 `ALTER TABLE` 操作被意外中断（如数据库崩溃或连接断开），可能导致表结构不一致。
- **默认值问题**：
  - 如果为新字段设置了默认值，MySQL 需要为每一行填充默认值，这可能会导致额外的性能开销。

---

## 4. **兼容性问题**
- **应用程序兼容性**：
  - 添加字段后，如果应用程序未适配新字段，可能导致查询或写入失败。
- **索引和约束**：
  - 如果新字段涉及索引或约束（如唯一约束），可能会影响现有数据的完整性。

---

## 5. **如何降低风险**
以下是一些降低 `ALTER TABLE` 操作风险的建议：

### 1. **选择合适的时机**
- 在业务低峰期（如夜间）执行操作，减少对业务的影响。

---

### 2. **使用 Online DDL**
- 确保 MySQL 版本在 5.6 及以上，并启用 Online DDL。
- 示例：
  ```sql
  ALTER TABLE xxx ADD COLUMN yyy INT, ALGORITHM=INPLACE, LOCK=NONE;
  ```
  - `ALGORITHM=INPLACE`：尽量减少表重建。
  - `LOCK=NONE`：避免锁表。

#### 关键参数解析
​**ALGORITHM=INPLACE**​
- ​作用​：避免全表复制，直接在原表上修改元数据或局部重建数据。
- 执行原理​：MySQL 5.6+​​,对于添加列操作，若满足条件（如非生成列、非自增列），仅修改数据字典（元数据），无需重建表；
- 支持场景​：添加可为 NULL 的列、添加带默认值（非常量表达式除外）的列等。

注意：
- ​MySQL 8.0+​​，默认使用 INSTANT 算法（仅修改元数据）。显式指定 INPLACE 时，若操作复杂（如列位置调整）可能触发局部数据重组。5.7 不支持 INSTANT。
- MySQL 5.7 在执行 DDL 时默认优先选择 INPLACE 算法（如添加二级索引、重命名列等），仅在操作不支持 INPLACE 时退化为 COPY 算法

​**LOCK=NONE**​
- ​作用​：最大限度允许并发读写，避免阻塞业务操作；
- 锁机制​：元数据锁（MDL）​​：仅在准备和提交阶段短暂获取排他锁（毫秒级），执行阶段降级为共享锁。
- 数据锁​：若操作无需重建数据（如列在末尾添加），全程无行锁；若需调整列顺序，可能短暂锁定受影响的数据页。

#### 对比其他算法
| **算法**       | **锁级别**       | **业务影响**       | **适用场景**              |
|----------------|------------------|--------------------|-------------------------|
| `ALGORITHM=COPY` | 表级排他锁（长时间） | 完全阻塞读写       | 修改数据类型、字符集转换 |
| `ALGORITHM=INSTANT` | 无锁或毫秒级锁    | 几乎无感知         | MySQL 8.0 添加末尾列   |
| **`INPLACE+LOCK=NONE`** | **短暂元数据锁** | **轻微读写影响**   | **添加可为空列/带默认值列** |

---

### 3. **备份数据**
- 在执行 `ALTER TABLE` 操作前，先备份数据，以防操作失败或数据丢失。

---

### 4. **测试环境验证**
- 在测试环境中模拟操作，验证添加字段的影响和耗时。

---

### 5. **分阶段操作**
- 对于大表，可以分阶段操作：
  1. 创建一个新表，包含新字段。
  2. 将数据从旧表迁移到新表。
  3. 重命名新表为旧表名。

---

### 6. **监控和回滚**
- 在操作过程中监控数据库性能，并准备好回滚方案（如使用 `pt-online-schema-change` 工具）。

---

## 6. **工具推荐**
- **pt-online-schema-change**：
  - Percona 提供的工具，可以在不锁表的情况下修改表结构。
  - 示例：
    ```bash
    pt-online-schema-change --alter "ADD COLUMN yyy INT" D=database,t=xxx
    ```

- **gh-ost**：
  - GitHub 开源的在线表结构变更工具，支持无锁表操作。

---

## 7. **总结**
- **风险**：`ALTER TABLE` 操作可能导致锁表、性能下降和数据一致性问题。
- **降低风险**：选择合适的时机、使用 Online DDL、备份数据、测试验证、分阶段操作或使用工具（如 `pt-online-schema-change`）。
- **建议**：对于大表或生产环境，优先使用无锁表工具进行操作，确保业务不受影响。

---

## references
https://mp.weixin.qq.com/s?__biz=MzkxNDY2NTAxNg==&mid=2247484928&idx=1&sn=2250fb9c7b9f0affdd4da2fc7e68a1db&chksm=c083defd479020a6475e460cf3a3694c68f49b20b15acd33f98f5573e3e30d9040071baeb9f0#rd 